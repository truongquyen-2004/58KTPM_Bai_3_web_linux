<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Shop Qu·∫ßn √Åo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <style>
    body { padding-top: 70px; }
    .product-card { border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 8px; text-align: center; }
    .product-card img { max-width: 100%; height: 180px; object-fit: cover; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#" id="nav-home">üëï Shop Qu·∫ßn √Åo</a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="nav-categories"></ul>
        <form class="d-flex" id="form-search">
          <input class="form-control me-2" type="search" placeholder="T√¨m s·∫£n ph·∫©m..." id="search-input">
          <button class="btn btn-outline-light" type="submit">T√¨m</button>
        </form>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#" id="nav-login">ƒêƒÉng nh·∫≠p</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="nav-logout" style="display:none;">ƒêƒÉng xu·∫•t</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- N·ªôi dung -->
  <div class="container mt-4" id="content"></div>

  <!-- Modal ƒëƒÉng nh·∫≠p -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">ƒêƒÉng nh·∫≠p</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="login-username" class="form-control mb-2" placeholder="T√™n ƒëƒÉng nh·∫≠p">
          <input type="password" id="login-password" class="form-control mb-3" placeholder="M·∫≠t kh·∫©u">
          <button id="btn-login" class="btn btn-primary w-100">ƒêƒÉng nh·∫≠p</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  const API = "http://truongvanquyen.com/nodered/api";
  let currentUser = null;

  $(document).ready(function() {
    loadCategories();
    loadProducts();

    // S·ª± ki·ªán navbar
    $("#nav-home").click(function(e) {
      e.preventDefault();
      loadProducts();
    });

    $("#nav-login").click(function(e) {
      e.preventDefault();
      $("#loginModal").modal("show");
    });

    $("#nav-logout").click(function(e) {
      e.preventDefault();
      logout();
    });

    // ƒêƒÉng nh·∫≠p
    $("#btn-login").click(function() {
      const username = $("#login-username").val();
      const password_hash = $("#login-password").val();
      $.ajax({
        url: API + "/login",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ username, password_hash }),
        xhrFields: { withCredentials: true },
        success: function(res) {
          if (res.success) {
            currentUser = res.user;
            $("#loginModal").modal("hide");
            updateLoginState();
            alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
          } else {
            alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u");
          }
        },
        error: () => alert("L·ªói k·∫øt n·ªëi server")
      });
    });

    // T√¨m ki·∫øm
    $("#form-search").submit(function(e) {
      e.preventDefault();
      const q = $("#search-input").val().trim();
      searchProducts(q);
    });
  });

  // ====== H√†m x·ª≠ l√Ω ======

  function loadCategories() {
    $.get(API + "/categories", function(data) {
      let html = "";
      data.forEach(c => {
        html += `<li class="nav-item">
                   <a class="nav-link category-link" href="#" data-id="${c.id}">${c.name}</a>
                 </li>`;
      });
      $("#nav-categories").html(html);
      $(".category-link").click(function(e) {
        e.preventDefault();
        const id = $(this).data("id");
        loadProducts(id);
      });
    });
  }

  function loadProducts(categoryId = null) {
    let url = API + "/products";
    if (categoryId) url += "/" + categoryId;
    $.get(url, function(data) {
      let html = '<div class="row">';
      data.forEach(p => {
        html += `
          <div class="col-md-3">
            <div class="product-card">
              <img src="${p.image || 'https://via.placeholder.com/200x180'}" alt="${p.name}">
              <h6 class="mt-2">${p.name}</h6>
              <p class="text-danger fw-bold">${p.price.toLocaleString()}‚Ç´</p>
              <button class="btn btn-sm btn-outline-primary" onclick="viewProduct(${p.id})">Chi ti·∫øt</button>
            </div>
          </div>`;
      });
      html += "</div>";
      $("#content").html(html);
    });
  }

  function viewProduct(id) {
    $.get(API + "/products/" + id, function(data) {
      const p = data[0];
      let html = `
        <div class="card mb-3">
          <div class="row g-0">
            <div class="col-md-4"><img src="${p.image || 'https://via.placeholder.com/400'}" class="img-fluid rounded-start"></div>
            <div class="col-md-8">
              <div class="card-body">
                <h5 class="card-title">${p.name}</h5>
                <p class="card-text text-danger fs-5">${p.price.toLocaleString()}‚Ç´</p>
                <p>M√£ s·∫£n ph·∫©m: ${p.id}</p>
                <button class="btn btn-primary" onclick="loadProducts()">‚Üê Quay l·∫°i</button>
              </div>
            </div>
          </div>
        </div>`;
      $("#content").html(html);
    });
  }

  function searchProducts(keyword) {
    $.ajax({
      url: API + "/search",
      method: "GET",
      data: { q: keyword },
      success: function(data) {
        let html = `<h4>K·∫øt qu·∫£ t√¨m ki·∫øm: "${keyword}"</h4><div class="row">`;
        data.forEach(p => {
          html += `
            <div class="col-md-3">
              <div class="product-card">
                <img src="${p.image || 'https://via.placeholder.com/200x180'}">
                <h6>${p.name}</h6>
                <p class="text-danger fw-bold">${p.price.toLocaleString()}‚Ç´</p>
              </div>
            </div>`;
        });
        html += "</div>";
        $("#content").html(html);
      },
      error: () => alert("L·ªói khi t√¨m ki·∫øm")
    });
  }

  function logout() {
    $.get(API + "/logout", {}, function() {
      currentUser = null;
      updateLoginState();
      alert("ƒê√£ ƒëƒÉng xu·∫•t");
    });
  }

  function updateLoginState() {
    if (currentUser) {
      $("#nav-login").hide();
      $("#nav-logout").show();
    } else {
      $("#nav-login").show();
      $("#nav-logout").hide();
    }
  }
  </script>
</body>
</html>
